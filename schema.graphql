####
# Protocol
#### 

type Protocol @entity {
    "Configurator proxy address"
    id: Bytes!

    configuratorProxy: Bytes!
    configuratorImplementation: Bytes

    cumulativeUsage: Usage! 

    # Derived
    markets: [Market!] @derivedFrom(field: "protocol")

    hourlyUsage: [ProtocolHourlyUsage!]! @derivedFrom(field: "protocol")
    dailyUsage: [ProtocolDailyUsage!]! @derivedFrom(field: "protocol")
}

####
# Tokens
####

type Token @entity {
    "Address"
    id: Bytes!

    address: Bytes!
    name: String!
    symbol: String!
    decimals: Int

    # Price
    lastPriceUsd: BigDecimal!
    lastPriceBlockNumber: BigInt!
}

type BaseToken @entity { 
    "market ID + token ID"
    id: Bytes!

    creationBlockNumber: BigInt!
    market: Market!
    token: Token!

    # Config
    lastConfigUpdateBlockNumber: BigInt!
    priceFeed: Bytes!

    # Price
    lastPriceUsd: BigDecimal!
    lastPriceBlockNumber: BigInt!
}

type CollateralToken @entity { 
    "Market ID + token ID + 'Col'"
    id: Bytes!

    creationBlockNumber: BigInt!
    market: Market!
    token: Token!

    # Config
    lastConfigUpdateBlockNumber: BigInt!
    priceFeed: Bytes!
    "Percent of collateral that can be borrowed against"
    borrowCollateralFactor: BigDecimal!
    "Percent of collateral that can be borrowed before the account becomes liquidate-able"
    liquidateCollateralFactor: BigDecimal!
    "Percent penalty incurred by the account upon liquidation, 0.93 => 7% penalty"
    liquidationFactor: BigDecimal!
    "Max amount that can be supplied to protect the protocol against over exposure"
    supplyCap: BigInt!

    # Price
    lastPriceUsd: BigDecimal!
    lastPriceBlockNumber: BigInt!
}

####
# Collateral Token Balances
####

interface CollateralBalance {
    id: Bytes!
    creationBlockNumber: BigInt!
    collateralToken: CollateralToken!

    # Balance
    lastUpdateBlockNumber: BigInt!
    balance: BigInt!
}

type MarketCollateralBalance implements CollateralBalance @entity {
    "Market id + collateral address + 'BAL'"
    id: Bytes!
    creationBlockNumber: BigInt!
    collateralToken: CollateralToken!

    "Market collateral is for"
    market: Market!

    # Balances
    lastUpdateBlockNumber: BigInt!
    balance: BigInt!
    reserves: BigInt!
}

type PositionCollateralBalance implements CollateralBalance @entity {
    "Position id + collateral address"
    id: Bytes!
    creationBlockNumber: BigInt!
    collateralToken: CollateralToken!

    "Position collateral is for"
    position: Position!

    # Balance
    lastUpdateBlockNumber: BigInt!
    balance: BigInt!
}

####
# Market
####

type Market @entity {
    ####
    # On creation only
    ####
    "Comet proxy address"
    id: Bytes!
    "Comet proxy address"
    cometProxy: Bytes!
    "Protocol this market is part of"
    protocol: Protocol!
    "Block number the market was created"
    creationBlockNumber: BigInt!

    ####
    # Configuration
    ####
    cometImplementation: Bytes

    lastConfigurationUpdateBlockNumber: BigInt!
    factory: Bytes!
    governor: Bytes!
    pauseGuardian: Bytes!
    extensionDelegate: Bytes!

    supplyKink: BigDecimal!
    supplyPerSecondInterestRateSlopeLow: BigInt!
    supplyPerSecondInterestRateSlopeHigh: BigInt!
    supplyPerSecondInterestRateBase: BigInt!

    borrowKink: BigDecimal!
    borrowPerSecondInterestRateSlopeLow: BigInt!
    borrowPerSecondInterestRateSlopeHigh: BigInt!
    borrowPerSecondInterestRateBase: BigInt!

    storeFrontPriceFactor: BigInt!
    trackingIndexScale: BigInt!

    baseTrackingSupplySpeed: BigInt!
	baseTrackingBorrowSpeed: BigInt!
	baseMinForRewards: BigInt!
	baseBorrowMin: BigInt!
	targetReserves: BigInt!

    baseToken: BaseToken! 

    ####
    # Accounting
    ####
    lastAccountingUpdatedBlockNumber: BigInt!

    baseSupplyIndex: BigInt!
    baseBorrowIndex: BigInt!
    trackingSupplyIndex: BigInt!
    trackingBorrowIndex: BigInt!
    lastAccrualTime: BigInt!
    
    totalBasePrincipalSupply: BigInt!
    totalBasePrincipalBorrow: BigInt!

    baseReserveBalance: BigInt!

    "Total amount of base supplied to the market in present value"
    totalBaseSupply: BigInt!
    "Total amount of base borrowed from the market in present value"
    totalBaseBorrow: BigInt!
    "Percent usage of the market, that is totalBaseBorrow / totalBaseSupply"
    utilization: BigDecimal!
    supplyApr: BigDecimal!
    borrowApr: BigDecimal!

    totalBaseSupplyUsd: BigDecimal!
    totalBaseBorrowUsd: BigDecimal!
    baseReserveBalanceUsd: BigDecimal!

    rewardSupplyApr: BigDecimal!
    rewardBorrowApr: BigDecimal!

    netSupplyApr: BigDecimal!
    netBorrowApr: BigDecimal!

    ####
    # Usage
    ####
    cumulativeUsage: Usage! 

    ####
    # Derived
    ####
    CollateralTokens: [CollateralToken!]! @derivedFrom(field: "market")
    collateralBalances: [MarketCollateralBalance!]! @derivedFrom(field: "market")
    positions: [Position!]! @derivedFrom(field: "market")

    supplyBaseMarketInteractions: [SupplyBaseMarketInteraction!]! @derivedFrom(field: "market")
    withdrawBaseMarketInteractions: [WithdrawBaseMarketInteraction!]! @derivedFrom(field: "market")
    absorbDebtMarketInteractions: [AbsorbDebtMarketInteraction!]! @derivedFrom(field: "market")
    supplyCollateralMarketInteractions: [SupplyCollateralMarketInteraction!]! @derivedFrom(field: "market")
    withdrawCollateralMarketInteractions: [WithdrawCollateralMarketInteraction!]! @derivedFrom(field: "market")
    transferCollateralMarketInteractions: [TransferCollateralMarketInteraction!]! @derivedFrom(field: "market")
    absorbCollateralMarketInteractions: [AbsorbCollateralMarketInteraction!]! @derivedFrom(field: "market") 

    hourlyUsage: [MarketHourlyUsage!]! @derivedFrom(field: "market")
    dailyUsage: [MarketDailyUsage!]! @derivedFrom(field: "market")
}

####
# Account
####

type Account @entity {
    "Address"
    id: Bytes!

    creationBlockNumber: BigInt!
    address: Bytes!

    ####
    # Derived
    ####
    positions: [Position!]! @derivedFrom(field: "account")
}

####
# Position
####

type Position @entity {
    ####
    # On creation only
    ####
    "Market proxy address + owner address"
    id: Bytes!
    "Block number the position was created"
    creationBlockNumber: BigInt!
    "Market the position is in"
    market: Market!
    "Owner of the position"
    account: Account!

    ####
    # On update
    ####
    lastUpdatedBlockNumber: BigInt!
    basePrincipal: BigInt!
    baseBalance: BigInt!
    baseTrackingIndex: BigInt!
    baseTrackingAccrued: BigInt!

    ####
    # Derived
    ####
    collateralBalances: [PositionCollateralBalance!]! @derivedFrom(field: "position")

    supplyBaseMarketInteractions: [SupplyBaseMarketInteraction!]! @derivedFrom(field: "position")
    withdrawBaseMarketInteractions: [WithdrawBaseMarketInteraction!]! @derivedFrom(field: "position")
    absorbDebtMarketInteractions: [AbsorbDebtMarketInteraction!]! @derivedFrom(field: "position")
    supplyCollateralMarketInteractions: [SupplyCollateralMarketInteraction!]! @derivedFrom(field: "position")
    withdrawCollateralMarketInteractions: [WithdrawCollateralMarketInteraction!]! @derivedFrom(field: "position")
    transferFromCollateralMarketInteractions: [TransferCollateralMarketInteraction!]! @derivedFrom(field: "fromPosition")
    transferToCollateralMarketInteractions: [TransferCollateralMarketInteraction!]! @derivedFrom(field: "toPosition")
    absorbCollateralMarketInteractions: [AbsorbCollateralMarketInteraction!]! @derivedFrom(field: "position") 
}

####
# Usage
####

type Usage @entity {
    ""
    id: Bytes!

    protocol: Protocol!

    uniqueUsersCount: BigInt!
    transactionCount: BigInt!
    supplyBaseCount: BigInt!
    withdrawBaseCount: BigInt!
    liquidationCount: BigInt!
    supplyCollateralCount: BigInt!
    withdrawCollateralCount: BigInt!
    transferCollateralCount: BigInt!
}

type ProtocolHourlyUsage @entity {
    "Days since unix epoche"
    id: Bytes!
    protocol: Protocol!
    hour: BigInt!
    usage: Usage!
}

type ProtocolDailyUsage @entity {
    "usage ID + hour since unix epoche"
    id: Bytes!
    protocol: Protocol!
    day: BigInt!
    usage: Usage!
}

type MarketHourlyUsage @entity {
    "Days since unix epoche"
    id: Bytes!
    market: Market!
    hour: BigInt!
    usage: Usage!
}

type MarketDailyUsage @entity {
    "usage ID + hour since unix epoche"
    id: Bytes!
    market: Market!
    day: BigInt!
    usage: Usage!
}


# Helper to track active accounts
type _ActiveAccount @entity {
    "Address + use case + id"
    id: Bytes!
}

####
# Interactions
####

interface ProtocolInteraction {
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    from: Bytes!
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt
}

interface MarketInteraction implements ProtocolInteraction {
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
}

type SupplyBaseMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: BaseToken!
    amount: BigInt!
    amountUsd: BigDecimal!
}

type WithdrawBaseMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: BaseToken!
    amount: BigInt!
    amountUsd: BigDecimal!
}

type AbsorbDebtMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: BaseToken!
    amount: BigInt!
    amountUsd: BigDecimal!

    absorber: Bytes!
}

type SupplyCollateralMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: CollateralToken!
    amount: BigInt!
    amountUsd: BigDecimal!
}

type WithdrawCollateralMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: CollateralToken!
    amount: BigInt!
    amountUsd: BigDecimal!
}

type TransferCollateralMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    fromPosition: Position!
    toPosition: Position!

    asset: CollateralToken!
    amount: BigInt!
    amountUsd: BigDecimal!
}

type AbsorbCollateralMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!
    position: Position!

    asset: CollateralToken!
    amount: BigInt!
    amountUsd: BigDecimal!

    absorber: Bytes!
}

type BuyCollateralMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!

    asset: CollateralToken!
    collateralAmount: BigInt!
    baseAmount: BigInt!
    amountUsd: BigDecimal!
}

type WithdrawReservesMarketInteraction implements MarketInteraction @entity(immutable: true) {
    "event hash + logIndex"
    id: Bytes!

    hash: Bytes!
    logIndex: BigInt!
    blockNumber: BigInt!
    timestamp: BigInt!

    "where value is being transferred from"
    from: Bytes!
    "where value is being transferred to"
    to: Bytes!

    gasLimit: BigInt!
    gasPrice: BigInt!
    gasUsed: BigInt

    market: Market!

    amount: BigInt!
    amountUsd: BigDecimal!
}
